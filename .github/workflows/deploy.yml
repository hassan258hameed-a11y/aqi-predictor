name: CI/CD AQI Pipeline

on:
  push:
    branches: [ main ]
  schedule:
    - cron: '0 * * * *'     # every hour
    - cron: '0 0 * * *'     # every day
  workflow_dispatch:        # allows manual runs

jobs:
  pipeline:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      # ‚úÖ This step ensures pandas and all packages are installed
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          python -m pip show pandas || echo "pandas not found"

      # ‚úÖ This step fixes Python import errors for src/
      - name: Set PYTHONPATH
        run: echo "PYTHONPATH=$PWD" >> $GITHUB_ENV

      - name: Run hourly feature update
        run: python src/fetch_features.py

      - name: Run daily model training
        run: python src/train.py

      - name: Verify model output
        run: |
          echo "üîç Checking saved model and registry..."
          ls -R src/models || echo "No model directory found."
          ls -R models || echo "No model folder found."
          find . -name "aqi_model.pkl" || echo "No model file found."


      - name: Deploy to Streamlit
        env:
          STREAMLIT_ACCESS_TOKEN: ${{ secrets.STREAMLIT_ACCESS_TOKEN }}
        run: |
          pip install streamlit
          streamlit run app/streamlit_app.py
